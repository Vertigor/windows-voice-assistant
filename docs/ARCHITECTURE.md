# 系统架构

本文档详细说明 Windows Voice Assistant 的系统架构设计。

## 总体架构

系统采用模块化分层架构，分为以下几层：

```
┌─────────────────────────────────────────────────────────┐
│              用户交互层 (User Interaction)               │
│  ┌──────────────┐              ┌──────────────────┐    │
│  │ 系统托盘图标  │              │ 快捷键/唤醒词监听 │    │
│  │  (Pystray)   │              │ (Pynput/STT)     │    │
│  └──────────────┘              └──────────────────┘    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              核心逻辑层 (Core Logic)                     │
│  ┌─────────────────────────────────────────────────┐   │
│  │         主应用控制器 (App Controller)            │   │
│  │  - 协调各模块                                    │   │
│  │  - 管理应用生命周期                              │   │
│  │  - 维护对话上下文                                │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│            语音交互模块 (Voice Interaction)              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   语音识别    │  │   意图理解    │  │   语音合成    │ │
│  │  (Whisper)   │→ │  (Ollama)    │  │ (Coqui TTS)  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│            功能模块层 (Function Modules)                 │
│  ┌──────────────────────┐  ┌──────────────────────┐   │
│  │    邮件处理模块       │  │    文件整理模块       │   │
│  │  - IMAP/POP3         │  │  - 文件搜索          │   │
│  │  - Exchange          │  │  - 文件操作          │   │
│  │  - 邮件操作          │  │  - 自动整理规则       │   │
│  └──────────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│            数据持久层 (Data Persistence)                 │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐      │
│  │ 配置   │  │ 凭据   │  │ 日志   │  │ 规则   │      │
│  └────────┘  └────────┘  └────────┘  └────────┘      │
└─────────────────────────────────────────────────────────┘
```

## 模块详解

### 1. 用户交互层

#### 系统托盘图标 (TrayIcon)
- **职责**: 提供图形化交互入口
- **功能**: 
  - 显示应用状态
  - 提供右键菜单
  - 启动/停止监听
  - 打开设置和日志

#### 快捷键/唤醒词监听
- **职责**: 捕获用户激活信号
- **实现**: 
  - 使用 `pynput` 监听全局快捷键
  - 使用 `RealtimeSTT` 的唤醒词功能

### 2. 核心逻辑层

#### 主应用控制器 (AppController)
- **职责**: 应用的中枢神经
- **功能**:
  - 初始化和协调所有模块
  - 管理应用生命周期
  - 处理任务队列
  - 维护对话上下文
  - 错误处理和恢复

**关键方法**:
```python
- start(): 启动应用
- stop(): 停止应用
- on_voice_activated(): 语音激活回调
- on_voice_transcribed(): 语音转录回调
- speak(): 语音播报
```

### 3. 语音交互模块

#### 语音处理管道 (VoicePipeline)
- **职责**: 整合 STT、NLU 和 TTS
- **流程**:
  1. 接收音频输入
  2. 实时转录为文本
  3. 调用 LLM 理解意图
  4. 返回结构化的意图和实体
  5. 将结果文本合成语音

**技术栈**:
- **STT**: RealtimeSTT + Whisper
- **NLU**: Ollama + 本地 LLM
- **TTS**: Coqui TTS

### 4. 功能模块层

#### 任务执行器 (TaskExecutor)
- **职责**: 根据意图分发任务
- **支持的意图**:
  - `view_email`: 查看邮件
  - `delete_email`: 删除邮件
  - `mark_email`: 标记邮件
  - `search_file`: 搜索文件
  - `move_file`: 移动文件
  - `delete_file`: 删除文件
  - `add_rule`: 添加整理规则

#### 邮件处理模块 (EmailHandler)
- **职责**: 处理所有邮件相关操作
- **支持协议**:
  - IMAP/POP3 (使用 `IMAPClient`)
  - Exchange (使用 `exchangelib`)
- **功能**:
  - 连接邮件服务器
  - 搜索和筛选邮件
  - 读取邮件内容
  - 标记、删除、移动邮件

#### 文件整理模块 (FileHandler)
- **职责**: 处理所有文件相关操作
- **功能**:
  - 文件搜索（支持全盘或指定目录）
  - 文件移动、复制、删除
  - 文件监控（使用 `watchdog`）
  - 自动应用整理规则

### 5. 数据持久层

#### 配置管理 (ConfigManager)
- **职责**: 管理应用配置
- **功能**:
  - 加载和保存配置文件
  - 加密存储敏感信息
  - 提供配置访问接口

**配置文件位置**: `%APPDATA%\VoiceAssistant\config.json`

#### 日志管理 (Logger)
- **职责**: 记录应用运行日志
- **功能**:
  - 多级别日志（DEBUG, INFO, WARNING, ERROR）
  - 自动轮转（单文件最大 10MB）
  - 同时输出到文件和控制台

**日志文件位置**: `%APPDATA%\VoiceAssistant\logs\`

## 数据流

### 语音指令处理流程

```
用户说话
  ↓
唤醒词检测/快捷键触发
  ↓
开始录音 (RealtimeSTT)
  ↓
实时转录 (Whisper)
  ↓
意图理解 (Ollama LLM)
  ↓
提取意图和实体
  ↓
任务执行器分发
  ↓
调用相应功能模块
  ↓
返回执行结果
  ↓
语音合成 (Coqui TTS)
  ↓
播放语音反馈
```

### 邮件查看流程

```
用户: "查看今天的未读邮件"
  ↓
意图: view_email
实体: {time: "今天", status: "未读"}
  ↓
TaskExecutor.execute()
  ↓
EmailHandler.view_emails()
  ↓
连接邮件服务器
  ↓
构建搜索条件
  ↓
执行搜索
  ↓
获取邮件列表
  ↓
格式化结果
  ↓
返回: "找到 3 封邮件，第一封..."
  ↓
TTS 播报结果
```

### 文件整理流程

```
新文件创建
  ↓
Watchdog 检测到事件
  ↓
FileOrganizer.on_created()
  ↓
FileHandler.apply_rules()
  ↓
遍历整理规则
  ↓
匹配规则条件
  ↓
执行规则动作 (移动/删除)
  ↓
记录日志
```

## 安全设计

### 凭据加密
- 使用 `cryptography.Fernet` 对称加密
- 密钥存储在本地，权限设置为仅当前用户可读
- 邮箱密码等敏感信息加密后存储

### 危险操作确认
- 删除文件/文件夹需要二次确认
- 通过语音提问用户
- 等待明确的确认指令

### 操作日志
- 所有文件操作记录日志
- 便于追溯和审计
- 用户可手动清除

## 性能优化

### 模型量化
- 使用量化后的 Whisper 模型
- 推荐使用 `faster-whisper` 变体
- LLM 使用 3B 参数级别的模型

### 异步处理
- 使用任务队列处理语音指令
- 避免阻塞主线程
- 提高响应速度

### 资源管理
- 延迟加载非核心模块
- 及时释放不用的资源
- 邮件客户端连接池

## 扩展性

### 添加新功能模块

1. 在 `voice_assistant/modules/` 创建新模块
2. 实现功能逻辑
3. 在 `TaskExecutor` 中注册新意图
4. 更新 LLM Prompt 支持新意图

### 支持新的邮件协议

1. 在 `EmailHandler` 中添加新的客户端创建方法
2. 实现协议特定的操作方法
3. 更新配置文件格式

### 集成外部服务

1. 在 `modules/` 下创建新的处理器
2. 通过配置文件管理 API 密钥
3. 在 `TaskExecutor` 中集成

## 依赖关系

```
AppController
  ├── ConfigManager
  ├── Logger
  ├── VoicePipeline
  │   ├── RealtimeSTT
  │   ├── Whisper
  │   ├── Ollama
  │   └── Coqui TTS
  ├── TaskExecutor
  │   ├── EmailHandler
  │   │   ├── IMAPClient
  │   │   └── exchangelib
  │   └── FileHandler
  │       └── watchdog
  └── TrayIcon
      └── pystray
```

## 未来规划

- [ ] 支持更多邮件协议
- [ ] 集成日历和提醒功能
- [ ] 支持自然语言编写邮件
- [ ] 文件内容搜索
- [ ] 多语言支持
- [ ] Web 控制面板
- [ ] 移动端远程控制
